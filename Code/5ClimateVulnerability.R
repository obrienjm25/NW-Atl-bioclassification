# Project and Code Overview ====
#
# Project:      Bioclassification
# Contact:      e-mail: John.Obrien@dfo-mpo.gc.ca | tel: +1.782.640.1522
# Publication:  O'Brien JM, Stanley RRE, Jeffery NW, Heaslip SG, DiBacco C, Wang Z
#               (2021) Modelling demersal fish and benthic invertebrate assemblages 
#               in support of marine conservation planning. Ecol Appl
#
# Overview:
#
# In Maritimes Bioregion-
#
# 1. Examine observed frequency of major assemblages before (< 2012) and 
#    after (> 2012); a period of warming on the Scotian Shelf
# 2. Compare with hindcast predictions of random forest classifier to
#    evaluate accuracy of predictions
# 3. Project distribution of predominant assemblage types in 2075
#    under RCP scenario 8.5
# 4. Identify areas and assemblage types vulnerable to change
# 5. Figure Prep
#
# Requirements:
# R version 3.6.3
# Position and catch composition data from Department of Fisheries and Oceans Canada 
# annual multispecies bottom trawl surveys in Maritimes Region from 2007 to 2016
# 4-km fishnet grid spanning study area
# GIS layers summarizing environmental variables retained in random forest
# classification fit in 4RandomForestClassification.R from 2007-2011 and 2012-2016
# GIS layers summarizing bottom temperature and salinity conditions predicted from
# BIO North Atlantic Model for year 2075 under RCP 8.5

# House Keeping ====

# Load required packages

library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(cowplot)
library(sf)
library(raster)
library(simba)
library(dendroextras)
library(dendextend)
library(caret)
library(pROC)
library(randomForest)

# Source functions

source('Code/BioclassificationFunctions.R')

# Set controls

# String identifying the regional study area (i.e. NGSL, SGSL, NL, or MAR)
region <- "MAR"

# Habitat associations of taxa to be included
BottomHabitats <- c('bathydemersal', 'benthic', 'benthopelagic', 
                    'demersal', 'sessile', 'reef-associated', 
                    'bathypelagic')

# Combination of variables in survey datasets that uniquely define a trawl set
IDvars <- c("year", "month", "day", "set")

# Get colour palettes
source("Code/ColourPalettes.R")

# Coordinate reference system of desired projection (integer EPSG code)
crs_proj <- 26920

# Load fishnet grid

grid <- st_read("Data/Shapefiles/Grid4km_MAR.shp") %>% 
  st_set_crs(crs_proj)

# 1. Examine observed frequency of major assemblages ====
#    before (< 2012) and after (> 2012); a period of warming on the Scotian Shelf

# Separate trawl data into 2 times periods (pre-2012, post-2012)

trawl_data <- readRDS(file = paste0("Data/TrawlData_", region, ".rds")) %>% 
  filter(vertical.position %in% BottomHabitats) %>%
  filter(year >= 2007) %>% 
  filter(!grepl("atlantic herring", common_name, ignore.case = TRUE)) %>%
  rowwise() %>% 
  mutate(SetID = paste(c_across(all_of(IDvars)), collapse = "_")) %>% 
  ungroup()

MAR_Pre2012 <- filter(trawl_data, year >= 2007 & year < 2012) # 25812 observations

MAR_Post2012 <- filter(trawl_data, year >= 2012) # 25497 observations

# Make list object with pre- and post-2012 dataframes

MAR_list <- list(MAR_Pre2012, MAR_Post2012)

# Reshape and convert to simple features (point geometry)

trawl_wide <- MAR_list %>% 
  map(~pivot_wider(.x, 
                          id_cols = SetID, 
                          names_from = species,
                          values_from = totwgt,
                          values_fn = sum,
                          values_fill = 0)) %>% 
  map(~inner_join(.x, trawl_data[!duplicated(trawl_data$SetID),], by = "SetID")) %>% 
  map(~dplyr::select(.x, SetID, longitude, latitude, all_of(IDvars), 
                     any_of(unique(trawl_data$species)))) %>% 
  map(~st_as_sf(.x, coords = c("longitude", "latitude"), crs = 4326)) %>% 
  map(~st_transform(.x, crs = crs_proj))

# Spatial join of trawl points with 4-km fishnet

joinedgrid <- map(trawl_wide, ~st_join(grid, .x)) %>%
  map(~filter(.x, !is.na(SetID)))

# List of populated grid cells in each time period

populated <- map(joinedgrid, ~unique(.x$GridID))

# List of taxa

taxa <- joinedgrid %>% 
  map(~st_drop_geometry(.x)) %>% 
  map(~names(.x)) %>% 
  map(~setdiff(.x, c("GridID", "SetID", IDvars)))

# Site X Species matrix (0 = absent, 1 = present)

SiteXSpecies <- joinedgrid %>%
  # remove geometry column
  map(~st_drop_geometry(.x)) %>% 
  # select GridID and taxa columns
  map2(., taxa, ~dplyr::select(.x, GridID, all_of(.y))) %>% 
  map(~group_by(., GridID)) %>%
  # sum catch data where 2+ sets fall in same grid cell
  map2(., taxa, ~summarise(.x, across(all_of(.y), sum))) %>% 
  map(~ungroup(.)) %>% 
  # convert to P-A
  map2(., taxa, ~mutate(.x, across(all_of(.y), ~if_else(.x > 0, 1, 0))))

# Determine which grid cells had trawl sets before and after 2012

overlap <- intersect(SiteXSpecies[[1]]$GridID, SiteXSpecies[[2]]$GridID) # 238 cells

cat(length(overlap), "grid cells sampled in both time periods")

# Save object

saveRDS(overlap, file = 'Data/Maritimes_overlappingSite.rds')

# Create 2 versions of SiteXSpecies dataframe 
# a) using pre 2012 data for overlapping sites
# b) using post 2012 data for overlapping sites

SiteXSpecies2 <- vector('list', 2)
SiteXSpecies2[[1]] <- bind_rows(SiteXSpecies[[1]], filter(SiteXSpecies[[2]], !(GridID %in% overlap)))  
SiteXSpecies2[[1]][is.na(SiteXSpecies2[[1]])] <- 0
SiteXSpecies2[[2]] <- bind_rows(filter(SiteXSpecies[[1]], !(GridID %in% overlap)), SiteXSpecies[[2]]) 
SiteXSpecies2[[2]][is.na(SiteXSpecies2[[2]])] <- 0

# Ordered taxa names encompassing both time periods
taxa_ord <- SiteXSpecies2[[1]] %>% 
  dplyr::select(., -any_of(IDvars), -GridID) %>% 
  names(.) %>%
  sort(.)

# Reorder columns by species names
SiteXSpecies2  <-  map(SiteXSpecies2, ~dplyr::select(.,GridID, taxa_ord)) 

# Examine frequency of clusters for those grid cells overlapping both time periods

# Identify barren sites (i.e. those with 1 or fewer taxa recorded)

BarrenSites <- SiteXSpecies2 %>% 
  map(~rowwise(.x)) %>% 
  # calculate taxa richness at each site
  map(~mutate(.x, TaxaCount = sum(c_across(all_of(taxa_ord))))) %>% 
  map(~ungroup(.x)) %>%  
  map(~filter(.x, TaxaCount < 2)) %>% 
  map(~pull(.x, GridID))

# Identify rare taxa (i.e. those observed at fewer than 1% of sites)

dropThreshold <- map(SiteXSpecies2, ~(ceiling(nrow(.x)*0.01)))

rareTaxa <- SiteXSpecies2 %>% 
  map(., ~dplyr::select(.x, all_of(taxa_ord))) %>% 
  map(~colSums(.)) %>% 
  map2(., dropThreshold, ~Filter(f = function(x) {x < .y}, x = .x)) %>% 
  map(~names(.))

# Trim the data

SiteXSpecies_trim <- SiteXSpecies2 %>% 
  map2(., BarrenSites, ~filter(.x, !(GridID %in% .y))) %>% 
  map2(., rareTaxa, ~dplyr::select(.x, -all_of(.y))) %>% 
  map(., data.frame) %>% 
  map(., ~`rownames<-`(., .$GridID)) %>% 
  map(., ~dplyr::select(., -GridID))

# Save the data

write.csv(SiteXSpecies_trim[[1]], "Data/ClusterData4kmPre2012.csv", row.names=TRUE)
write.csv(SiteXSpecies_trim[[2]], "Data/ClusterData4kmPost2012.csv", row.names=TRUE)

# Create dendrogram object for both pre & post 2012 subsets
# Simpson's distance and average linkage method 

dendro <- map(SiteXSpecies_trim, ~ sim(.x, method = 'simpson')) %>% 
  map(~hclust(.x, method = 'average'))

# Cut tree at chosen threshold to generate clusters

thresh <- 0.607
cl <- map(dendro, ~dendroextras::slice(.x, h = thresh))

# Get frequency table of cluster memberships

cl_tbl <- map(cl, ~as.data.frame(table(.x))) %>%  
  map(~arrange(., desc(Freq))) %>% # order by frequency
  map(., print) #Number of sites in each cluster

# Create df w/ Grid Id and cluster assignment

# Join GridID and cluster assignments
cl_assigned <- map(cl, ~tibble(GridID = names(.x), cl = .x)) %>%
  map(~mutate(., GridID = as.integer(GridID),
         cl = as.factor(cl)))

# Recode clusters
cl_assigned[[1]]$cl <- recode(cl_assigned[[1]]$cl, 
                              `6` = "WSS: Banks/Inner BoF",
                              `7` = "WSS/Outer BoF",
                              `8` = "ESS: Banks",
                              `11` = "ESS",
                              `10` = "LC/Shelf Break", 
                              `1` = "Slope", 
                              .default = "Other")

cl_assigned[[2]]$cl <- recode(cl_assigned[[2]]$cl, 
                              `11` = "WSS: Banks/Inner BoF",
                              `9` = "WSS/Outer BoF",
                              `2` = "ESS: Banks",
                              `4` = "ESS",
                              `3` = "LC/Shelf Break", 
                              `1` = "Slope", 
                              .default ="Other" )

# Combine both time periods into one df
cl_assigned <- bind_rows(filter(cl_assigned[[2]], GridID %in% overlap),
                         filter(cl_assigned[[1]], GridID %in% overlap),
                         .id = "Period") %>% 
  mutate(Period = recode(Period, "2" = "2007-2011", "1" = "2012-2016")) #recode groups

# Save cluster assignments for overlapping grid cells
saveRDS(object = cl_assigned, 
        file = "Output/Maritimes_OverlappingSites_Assignment.rds")

# Calculate frequencies by cluster and time period

freqCl <- cl_assigned %>% 
  group_by(Period, cl) %>% 
  dplyr::count(., sort = FALSE) %>% 
  bind_rows(., data.frame(Period = "2012-2016",
                         cl = "Slope",
                         n = 0)) %>% 
  mutate(cl = factor(cl, levels = c("Slope", "LC/Shelf Break", "ESS", "ESS: Banks", 
                                    "WSS/Outer BoF", "WSS: Banks/Inner BoF")))

# 2. Compare with hindcast predictions of random forest classifier ====

# Read in model object, shapefiles, rasters

# random forest model object
RF_mod <- readRDS("Output/MAR_RF_model.rds") 
# time period labels
time_periods <- c("pre2012", "post2012") 
# study area boundaries
StudyArea <- st_read("Data/Shapefiles/StudyArea_MAR.shp") 
# Polygon for coastline
Land <- st_read("Data/Shapefiles/LandBorders_MAR.shp")
# 5-km land buffer
LandBuffer <- Land %>% 
  st_buffer(5000) 

# Stack of environmental raster layers buffered 5-km from shore
env_pred <- time_periods %>% 
  map(., ~list.files(path = paste0("Data/Rasters/", .x), # list of raster files
                     pattern = "Mar.+tif$",
                     full.names = TRUE)) %>% 
  map(., stack) %>% # stack rasters
  map(~mask(.x, LandBuffer, inverse = TRUE)) %>% # mask cells touching land buffer
  map(~mask(., StudyArea)) %>% # mask cells outside study area boundaries
  map(~`names<-`(.x, gsub("Mar_","",names(.x)))) %>% # remove "Mar_" from layer names
  map(~`names<-`(.x, gsub("_p.+2012", "", names(.x)))) # remove time period suffix from layer names

# Predict cluster membership for both time periods over entire Scotian Shelf

predict_map <- map(env_pred, ~raster::predict(.x, RF_mod)) 

# Plot comparison

par(mfrow = c(1,2))
map(predict_map, plot)

# Write predictions to file

writeRaster(predict_map[[1]], 
            filename = "Output/Maritimes_Hindcast2007_2011_map.tif", 
            overwrite = TRUE)
writeRaster(predict_map[[2]], 
            filename = "Output/Maritimes_Hindcast2012_2015_map.tif", 
            overwrite = TRUE) 

# Predict cluster membership for cells overlapping both time periods only

# subset grid cells sampled in each period
overlapCells <- filter(grid, GridID %in% overlap) 

# extract data for overlapping cells
overlap_data <- map(env_pred, ~raster::extract(.x, 
                                               overlapCells, 
                                               factors = TRUE, 
                                               nl = nlayers(.x), 
                                               df = TRUE)) %>% 
  # add grid IDs to dataframe
  map(~bind_cols(GridID = overlapCells$GridID, dplyr::select(.x,-ID))) %>% 
  map(., data.frame)

# predicted cluster assignment for overlapping cells
overlap_pred <- map(overlap_data, ~predict(object = RF_mod, 
                                           newdata = .x, 
                                           type = "response")) %>% 
  map2(., overlap_data, ~data.frame(predicted = .x, GridID = .y$GridID)) %>% 
  set_names(., nm = c("2007-2011", "2012-2016"))

# Compare predictions with cluster assignments from hierarchical clustering

assignments <- cl_assigned %>% #cluster assignments
  arrange(., GridID) %>% #order rows by grid ID ascending
  arrange(., Period) %>% #group by time period
  left_join(., data.table::rbindlist(overlap_pred, idcol = "Period")) %>% #bind observed cluster assignments with model predictions
  dplyr::rename(., observed = cl) %>% #rename columns
  filter_all(., all_vars(!is.na(.))) # remove incomplete cases (grid cells without complete suite of environmental predictors)

# reorder factor levels of predicted assignment to match order of observed factor levels

assignments$predicted <- factor(assignments$predicted, 
                                levels = levels(assignments$observed))

# Compute confusion matrix for both time periods pooled (74.8% accuracy)

confusionHindcast <- confusionMatrix(data = assignments$predicted,
                                     reference = assignments$observed) 
saveRDS(confusionHindcast, "Output/ConfusionMatrixAllTimes.rds") 

# more accurately predicts true positives for slope, and banks clusters

# Confusion matrix for 2007-2011 only (71.2% accuracy)

confusionHindcastpre2012 <- confusionMatrix(data = assignments$predicted[assignments$Period == "2007-2011"], 
                                            reference = assignments$observed[assignments$Period == "2007-2011"])
saveRDS(confusionHindcastpre2012 , "Output/ConfusionMatrixPre2012.rds")

# Confusion matrix for 2012-2016 only (78.4% accuracy)

confusionHindcastpost2012 <- confusionMatrix(data = assignments$predicted[assignments$Period == '2012-2016'], 
                                             reference = assignments$observed[assignments$Period == '2012-2016'])
saveRDS(confusionHindcastpost2012, "Output/ConfusionMatrixPost2012.rds")

# Evaluate accuracy of predictions with AUC

# Get assignment probabilities

  overlap_prob <- map(overlap_data, ~predict(object = RF_mod, 
                                             newdata = .x, 
                                             type = "prob")) %>% 
    map(., data.frame) %>% #convert to dataframe
    map(~`colnames<-`(.x, c("ESS", "ESS: Banks", "LC/Shelf Break",
                            "Slope", "WSS/Outer BoF","WSS: Banks/Inner BoF"))) %>% #rename
    data.table::rbindlist(., idcol = "time_period") %>% #row bind probabilities for pre 2012 and post 2012 data 
    filter_all(., all_vars(!is.na(.))) #remove rows with NA's

# Calculate multiclass ROC (and AUC)
mROC <- multiclass.roc(response = assignments$observed, 
                       predictor = dplyr::select(overlap_prob,-time_period))

cat("multiclass AUC =", mROC$auc)

# 3. Project distribution of predominant assemblages in 2075 under RCP 8.5 ====

# Read in environmental predictors with projected bottom temperature and salinity
# from BIO North Atlantic Model

env_future <- list.files(path = "Data/Rasters/FutureClimate", # list of raster files
                       pattern = "Mar",
                       full.names = TRUE) %>% 
  stack() %>% # stack rasters
  mask(., LandBuffer, inverse = TRUE) %>% # mask cells touching land buffer
  mask(., StudyArea) %>%  # mask cells outside study area boundaries
  `names<-`(.,gsub('Mar_','',names(.)))#remove 'Mar_' from layer names

# Predict cluster membership for 2075 under RCP85 scenario over entire Scotian Shelf

project_map <- raster::predict(env_future, RF_mod) 

# Plot comparison

plot(project_map)

# Write predictions to file

writeRaster(project_map, 
            filename = "Output/Maritimes_Forecast2075_map.tif", 
            overwrite = TRUE) #write predictions to file  

# 4. Identify areas and assemblage types vulnerable to change ====

# Identify anomalies from present classification

# Current classification
present_class <- raster("Output/MAR_PredClust_map.tif")

# Raster layer w/ binary values 1 = classification changed, 0 = no change
grid_anomalies <- project_map != present_class 

# Write anomalies layer to file
writeRaster(grid_anomalies, 
            filename = "Output/MAR_GridAnomalies_RCP85_2075.tif", 
            overwrite = TRUE)

# Highlight areas vulnerable to change 
ClimateSensitive <- rasterToPolygons(grid_anomalies, 
                                     fun = function(x){x>0}, 
                                     na.rm = TRUE) %>%  
  aggregate() %>% 
  st_as_sf()

# Write polygons to shapefile
st_write(st_as_sf(ClimateSensitive), 
         dsn = "Output", 
         layer = "MAR_ClimateSensitive", 
         driver = "ESRI Shapefile")

# Determine change in area of each group

# present classification 
present_class <- raster("Output/MAR_PredClust_map.tif") 
# 2075 classification, RCP 8.5
future_class <- raster("Output/Maritimes_Forecast2075_map.tif") 

Cl_area <- data.frame(Cluster = c("ESS", "ESS: Banks", "Laurentian Channel/Shelf Break",
                                  "Slope", "WSS/Outer BoF","WSS: Banks/Inner BoF"),
                      # Total grid cells in each cluster
                      area_present = as.vector(table(raster::values(present_class))),
                      area_future = as.vector(table(raster::values(future_class)))) %>% 
  mutate_if(.,is.integer, function(x){x*16}) %>% # Calculate area of each cluster
  mutate(., area_change = area_future - area_present, # Change in area of each cluster
         perc_change = ((area_future - area_present)/area_present)*100, # Percent change
         relative_area = (area_future/area_present)*100) # Relative size of each cluster to present conditions

Cl_area$Cluster <- factor(Cl_area$Cluster, 
                          levels = Cl_area$Cluster[order(Cl_area$perc_change)])

# 5. Figure Prep ====

## Fig. 5 ----

# Plot comparison of frequency by cluster between time periods

my_colours <- MAR.palette$assigned[c(6,4,5,3,1,2)] # colour scheme
names(my_colours) <- unique(freqCl$cl)

plot_freq <- ggplot(freqCl) + 
  geom_bar(aes(x = cl, 
               y = n, 
               group = Period, 
               fill = cl, 
               alpha = Period, 
               color = Period), 
           stat = "identity", 
           position = position_dodge2(padding=0.1)) +
  labs(x = NULL, y = "Number of sites") +
  theme_classic() +
  scale_alpha_manual(values = c(1,0.75)) + 
  scale_fill_manual(name = "Assemblage", 
                    values = my_colours) +
  theme(axis.text.x = element_text(angle = 50, hjust = 1),
        text = element_text(size = 14),
        panel.border = element_rect(fill = NA, colour = "black")) +
  scale_color_manual(values = c("black", "black"))

ggsave(plot = plot_freq, 
       file = "Output/Maritimes_splitComparison.tiff", 
       width = 6, 
       height = 4.5, 
       units = "in", 
       dpi = 300, 
       compression = "lzw")

## Fig. 6 ----

# Plot change in cluster area between present and 2075 classifications

pal <- MAR.palette$assigned[c(5,4,3,6,1,2)] # colour palette

plot_change <- ggplot(Cl_area, aes(x = Cluster, 
                                   y = perc_change, 
                                   fill = Cluster, 
                                   color = Cluster)) +
  geom_bar(show.legend = FALSE, 
           stat = "identity") +
  theme_classic() +
  scale_fill_manual(values = pal) +
  labs(x = NULL, y = "Change in area (%)") +
  scale_x_discrete(labels = c("LC/Shelf Break","ESS Banks","ESS","Slope",
                              "WSS/Outer BoF", "WSS Banks/Inner BoF")) +
  coord_flip() +
  theme(text = element_text(size = 16), 
        axis.title.x = element_text(margin = ggplot2::margin(12,0,0,0,"pt"), hjust = 0.5),
        axis.ticks.length = unit(2, "mm")) +
  scale_color_manual(values = rep("black", 6))

saveRDS(plot_change, "Output/Maritimes_ChangeClusterArea.rds")

# Map projected assemblage distributions in 2075 under RCP 8.5
# Highlight areas that are vulnerable to change

# Colour palette

pal <- eval(parse(text = paste0(region, ".palette"))) %>% 
  arrange(name) %>% 
  dplyr::select(-cl) %>% 
  filter(name != "Unclassified")

# Load additional spatial layers

# Polygon of raster boundaries
raster_boundary <- st_read(paste0("Data/Shapefiles/", region, "_RasterBoundary.shp")) %>% 
  st_set_crs(crs_proj)

# Border of climate susceptible areas
climate_sensitive <- st_read("Output/MAR_ClimateSensitive.shp") %>% 
  st_set_crs(26920)

# Predictions for 2075 under RCP 8.5
RF_pred2075 <- raster("Output/Maritimes_Forecast2075_map.tif") 

# convert to sf object
RF_pred2075_sf <- as(RF_pred2075, "SpatialPolygonsDataFrame") %>% 
  st_as_sf() %>% 
  `names<-`(., c("ID", "geometry")) %>% 
  left_join(., levels(RF_pred2075)[[1]]) %>% 
  rename(name = category) %>% 
  left_join(., pal)

# Map forecasted distribution and highlight climate sensitive areas

map_projection <- plot_colourmap(col_map = RF_pred2075_sf,
                              boundaries_poly = raster_boundary,
                              land_poly = Land,
                              uncertainty = NULL,
                              label_position = "SE",
                              expand_scale = FALSE,
                              xlim = c(0, 1040000),
                              ylim = c(4530000, 5300000),
                              x_breaks = c(-67,-63,-59),
                              y_breaks = c(47,45,43,41),
                              expansion_const = expr(waiver()),
                              region_tag = "",
                              tag_position = c(920000, 5220000),
                              ytext_angle = 270,
                              scalebar_position = "tl",
                              scalebar_width = 0.25,
                              scalebar_ypad = 0.5) +
  geom_sf(data = climate_sensitive, 
          aes(col = "blue"), 
          fill = "black",
          alpha = 0.15) +
  scale_color_identity(guide = "legend",
                       name = "",
                       labels = c("Climate susceptible (anomalies)")) +
  coord_sf(label_graticule = "SE",
           expand = FALSE,
           xlim = c(0, 1040000),
           ylim = c(4530000, 5300000)) +
  theme(legend.text = element_text(size = 12),
        legend.position = c(0.70,0.1),
        legend.background = element_blank(),
        plot.margin = ggplot2::margin(5.5,5.5,5.5,5.5, "pt"))
  
saveRDS(map_projection, file = "Output/MaritimesRF_predictions_ggmap_RCP85_2075.rds")

# Combine panels for change in area and projected distributions

panelA <- readRDS("Output/Maritimes_ChangeClusterArea.rds")
panelB <- readRDS("Output/MaritimesRF_predictions_ggmap_RCP85_2075.rds")

panel_fig <- plot_grid(panelA, panelB, 
                       align = "h", 
                       axis = "bt", 
                       rel_widths = c(1.05,1.5),
                       labels = "AUTO")

ggsave(panel_fig, 
       filename = "Output/Maritimes_2075_2panel.tiff",
       width = 9.2, 
       height = 4.5, 
       dpi = 300, 
       compression = "lzw")

cat("Move onto 6AncillaryAnalyses.R")
